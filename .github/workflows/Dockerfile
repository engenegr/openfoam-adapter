FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get -qq update && apt-get -qq install wget software-properties-common git build-essential pkg-config sudo

# Install OpenFOAM
ENV OPENFOAM_VERSION=2106
RUN wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | bash && \
    apt-get -qq install openfoam${OPENFOAM_VERSION}-dev openfoam${OPENFOAM_VERSION}-common openfoam${OPENFOAM_VERSION}-tools openfoam${OPENFOAM_VERSION} openfoam

RUN ls /usr/bin

# Install preCICE v2.2.1 from the Debian package
RUN wget https://github.com/precice/precice/releases/download/v2.2.1/libprecice2_2.2.1_focal.deb && \
    apt install -y ./libprecice2_2.2.1_focal.deb

# Create user precice
ARG uid=1000
ARG gid=1000
RUN groupadd -g ${gid} precice \
    && useradd -u ${uid} -g ${gid} -m -s /bin/bash precice \
    && sudo usermod -a -G sudo precice

# Setup passwordless sudo
RUN echo "ALL            ALL = (ALL) NOPASSWD: ALL" >> /etc/sudoers

# Switch to the user precice
USER precice
WORKDIR /home/precice
ENV USER=precice

# Use bash instead of default sh
SHELL ["/bin/bash", "-c"]

# Bust the cache: we want that the next steps are always executed
ARG CACHEBUST

# Build the OpenFOAM adapter
RUN git clone --depth 1 --branch develop https://github.com/precice/openfoam-adapter.git
WORKDIR /home/precice/openfoam-adapter
RUN /usr/bin/openfoam${OPENFOAM_VERSION} ./Allwmake
